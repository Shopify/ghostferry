<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Running ghostferry-copydb in production &#8212; Ghostferry 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=712fa57f" />
    <script src="_static/documentation_options.js?v=8d563738"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Interrupt and resuming ghostferry-copydb" href="copydbinterruptresume.html" />
    <link rel="prev" title="Tutorial for ghostferry-copydb" href="tutorialcopydb.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="running-ghostferry-copydb-in-production">
<span id="copydbinprod"></span><h1>Running <code class="docutils literal notranslate"><span class="pre">ghostferry-copydb</span></code> in production<a class="headerlink" href="#running-ghostferry-copydb-in-production" title="Link to this heading">¶</a></h1>
<p>Assuming you have gone through <a class="reference internal" href="tutorialcopydb.html#tutorialcopydb"><span class="std std-ref">Tutorial for ghostferry-copydb</span></a>, you probably want to run
<code class="docutils literal notranslate"><span class="pre">ghostferry-copydb</span></code> in production. The general workflow is relatively
similar, with some differences. You should keep the tutorial as a starting
point for your own playbook as most steps will largely be the same.</p>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">¶</a></h2>
<p>Before you start, you need to know if you can even use Ghostferry. Some points
to consider about this are:</p>
<ul class="simple">
<li><p>Ghostferry on its own does not enable zero downtime moves. The downtime for the
app will be minimal compared to other methods but still non-zero.</p>
<ul>
<li><p>Figure out how much downtime you are willing to tolerate. Using Ghostferry,
one can realistically achieve downtime in the order of seconds.</p></li>
</ul>
</li>
<li><p>The source database must be running with <a class="reference external" href="https://dev.mysql.com/doc/refman/5.7/en/replication-options-binary-log.html#sysvar_binlog_row_image">FULL image</a> <a class="reference external" href="https://dev.mysql.com/doc/refman/5.6/en/replication-options-binary-log.html#sysvar_binlog_format">ROW based replication</a>.</p>
<ul>
<li><p>Without this, it is not possible to run Ghostferry safely and Ghostferry
will error out if it detects <code class="docutils literal notranslate"><span class="pre">binlog_row_image</span></code> is not set to <code class="docutils literal notranslate"><span class="pre">FULL</span></code>.</p></li>
</ul>
</li>
<li><p>Tables to be copied have integer primary keys.</p>
<ul>
<li><p>An issue exists to fix this limitation here:
<a class="reference external" href="https://github.com/Shopify/ghostferry/issues/2">https://github.com/Shopify/ghostferry/issues/2</a>.</p></li>
<li><p>As a work around, you can use mysqldump during the cutover stage to migrate
those tables.</p></li>
</ul>
</li>
<li><p>There are no foreign key constraints in your tables.</p>
<ul>
<li><p>You should remove these constraints before running Ghostferry.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">ghostferry-copydb</span></code> can only copy a whole table at a time.</p>
<ul>
<li><p>If you need to copy a subset, use ghostferry as a library to build your own
application.</p></li>
</ul>
</li>
<li><p>In cases of a multi-node replication setup, Ghostferry should only be run on
the master database where writes occur. Otherwise there may be a race
condition causing some binlog entries to be missed.</p>
<ul>
<li><p>There may be a way to fix this in the future.</p></li>
</ul>
</li>
</ul>
</section>
<section id="testing-ghostferry-with-production-data">
<span id="prodtesting"></span><h2>Testing Ghostferry with Production Data<a class="headerlink" href="#testing-ghostferry-with-production-data" title="Link to this heading">¶</a></h2>
<p>You can run Ghostferry without running the cutover to test the entire flow
without actually moving your database. This allows you to verify that the move
will indeed work with your setup. Additionally, the target location where you
performed this test move can be used by a staging version of your app to verify
that the target MySQL will not cause trouble for your app, especially if the
target MySQL has different version/configurations.</p>
<p>If you want to test the entire flow including the cutover, you can as well with
some additional setup:</p>
<ol class="arabic simple">
<li><p>Setup a slave of the source database. Use this slave as the source database.</p></li>
<li><p>Use Ghostferry to copy the data from the slave to some target.</p></li>
<li><p>Stop replication on the source slave. This is the equivalent to setting the
database to read only.</p></li>
<li><p>Perform the cutover as normal. Can even run verification with this.</p></li>
</ol>
</section>
<section id="to-verify-or-not-to-verify">
<h2>To Verify Or Not To Verify<a class="headerlink" href="#to-verify-or-not-to-verify" title="Link to this heading">¶</a></h2>
<p>Ghostferry has two built-in verifiers. They are designed to give you certainty
that the data of the source and the target are identical after a move and
nothing was corrupted/missed. They are designed to be used during the cutover
process, when writes to the source database have stopped and writes to the
target have not yet started. During the run, both the source and target must
be kept read only and thus incur downtime for your dataset. The two different
verifiers have different downtime characteristics. See the <a class="reference internal" href="verifiers.html#verifiers"><span class="std std-ref">Verifiers</span></a>
page for more details on what they are and how to choose a verifier. This means
you have to decide if you want to verify or not.</p>
<p>In order to know how much downtime you will incur during the verification
process, you can test it with the slave based staging move described in
<a class="reference internal" href="#testing-ghostferry-with-production-data">Testing Ghostferry with Production Data</a>. During the cutover stages, run
verification as normal and measure the time taken.</p>
<p>Since the ultimate objective of the verifier is to verify that Ghostferry did
not make a mistake while copying the data and give you peace of mind, if you
were able to successfully perform the staging verification, you would know that
the system already works with your setup and data. At this point it may no
longer be necessary to run a verification during the production move as the
chance of a row that has changed between the staging run and the actual run
causing an issue is slim.</p>
<p>It is also possible to run a verification after a move and possibly address any
issues after the fact:</p>
<ol class="arabic simple">
<li><p>Setup a slave of the source database.</p></li>
<li><p>Setup a slave of the target database.</p></li>
<li><p>Run ghostferry as normal between the master source and target database.</p></li>
<li><p>During the cutover, also stop replication to the slaves setup in step 1 and
2.</p></li>
<li><p>Manually compare the table on the slaves using something like <code class="docutils literal notranslate"><span class="pre">CHECKSUM</span>
<span class="pre">TABLE</span></code>.</p></li>
</ol>
</section>
<section id="dealing-with-errors-and-restarting-runs">
<h2>Dealing with Errors and Restarting Runs<a class="headerlink" href="#dealing-with-errors-and-restarting-runs" title="Link to this heading">¶</a></h2>
<p>It is possible for Ghostferry to encounter an unrecoverable error (such as a
network partition with the database). In these scenarios, the target will be
left alone as the Ghostferry process panics and quits. It may be possible to
resume these runs using the experimental interrupt &amp; resume feature. See
<a class="reference internal" href="copydbinterruptresume.html#copydbinterruptresume"><span class="std std-ref">Interrupt and resuming ghostferry-copydb</span></a>.</p>
<p>If the resume doesn’t work, starting a brand new Ghostferry run is perfectly
fine.  For copydb specifically, you need to drop the databases created by
copydb on the target as it will try to recreate it.</p>
</section>
<section id="configuration-for-ghostferry-copydb">
<h2>Configuration for <code class="docutils literal notranslate"><span class="pre">ghostferry-copydb</span></code><a class="headerlink" href="#configuration-for-ghostferry-copydb" title="Link to this heading">¶</a></h2>
<p>The configuration for <code class="docutils literal notranslate"><span class="pre">ghostferry-copydb</span></code> is a JSON file. The schema it is
based on the <a class="reference external" href="https://godoc.org/github.com/Shopify/ghostferry#Config">Config struct of ghostferry</a>, with some
differences:</p>
<ul class="simple">
<li><p>You cannot specify <code class="docutils literal notranslate"><span class="pre">TableFilter</span></code> and <code class="docutils literal notranslate"><span class="pre">CopyFilter</span></code>.</p></li>
<li><p>If you are using the debian package, you don’t need to specify
<code class="docutils literal notranslate"><span class="pre">WebBasedir</span></code> as it is compiled into the binary.</p></li>
</ul>
<p>It also allows you specify some options according to fields defined by the
<a class="reference external" href="https://godoc.org/github.com/Shopify/ghostferry/copydb#Config">Config struct of copydb</a>. This allows
you to filter the databases/tables to copy as well as specify the type of
verifier.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Ghostferry</a></h1>



<p class="blurb"> The swiss army knife of live data migrations</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Shopify&repo=ghostferry&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction to Ghostferry</a></li>
<li class="toctree-l1"><a class="reference internal" href="technicaloverview.html">Technical Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorialcopydb.html">Tutorial for ghostferry-copydb</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Running <code class="docutils literal notranslate"><span class="pre">ghostferry-copydb</span></code> in production</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#testing-ghostferry-with-production-data">Testing Ghostferry with Production Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#to-verify-or-not-to-verify">To Verify Or Not To Verify</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dealing-with-errors-and-restarting-runs">Dealing with Errors and Restarting Runs</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuration-for-ghostferry-copydb">Configuration for <code class="docutils literal notranslate"><span class="pre">ghostferry-copydb</span></code></a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="copydbinterruptresume.html">Interrupt and resuming <code class="docutils literal notranslate"><span class="pre">ghostferry-copydb</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="verifiers.html">Verifiers</a></li>
<li class="toctree-l1"><a class="reference internal" href="howtousecustom.html">Using Ghostferry in Custom Applications</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="tutorialcopydb.html" title="previous chapter">Tutorial for ghostferry-copydb</a></li>
      <li>Next: <a href="copydbinterruptresume.html" title="next chapter">Interrupt and resuming <code class="docutils literal notranslate"><span class="pre">ghostferry-copydb</span></code></a></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2017-2024, Shopify.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/copydbinprod.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>