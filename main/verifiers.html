<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Verifiers &#8212; Ghostferry 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=712fa57f" />
    <script src="_static/documentation_options.js?v=8d563738"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using Ghostferry in Custom Applications" href="howtousecustom.html" />
    <link rel="prev" title="Interrupt and resuming ghostferry-copydb" href="copydbinterruptresume.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="verifiers">
<span id="id1"></span><h1>Verifiers<a class="headerlink" href="#verifiers" title="Link to this heading">¶</a></h1>
<p>Verifiers in Ghostferry are designed to ensure that Ghostferry did not
corrupt/miss data. There are three different verifiers: the
<code class="docutils literal notranslate"><span class="pre">ChecksumTableVerifier</span></code>, the <code class="docutils literal notranslate"><span class="pre">InlineVerifier</span></code>, and the <code class="docutils literal notranslate"><span class="pre">TargetVerifier</span></code>. A comparison of the
<code class="docutils literal notranslate"><span class="pre">ChecksumTableVerifier</span></code> and <code class="docutils literal notranslate"><span class="pre">InlineVerifier</span></code> are given below:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td></td>
<td><p>ChecksumTableVerifier</p></td>
<td><p>InlineVerifier</p></td>
</tr>
<tr class="row-even"><td><p>Mechanism</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">CHECKSUM</span> <span class="pre">TABLE</span></code></p></td>
<td><p>Verify row after insert;
Reverify changed rows before
and during cutover.</p></td>
</tr>
<tr class="row-odd"><td><p>Impacts on Cutover Time</p></td>
<td><p>Linear w.r.t data size</p></td>
<td><p>Linear w.r.t. change rate
<a class="footnote-reference brackets" href="#id4" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-even"><td><p>Impacts on Copy Time
<a class="footnote-reference brackets" href="#id5" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a></p></td>
<td><p>None</p></td>
<td><p>Linear w.r.t data size</p></td>
</tr>
<tr class="row-odd"><td><p>Memory Usage</p></td>
<td><p>Minimal</p></td>
<td><p>Linear w.r.t rows changed</p></td>
</tr>
<tr class="row-even"><td><p>Partial table copy</p></td>
<td><p>Not supported</p></td>
<td><p>Supported</p></td>
</tr>
<tr class="row-odd"><td><p>Worst Case Scenario</p></td>
<td><p>Large databases causes
unacceptable downtime</p></td>
<td><p>Verification is slower than
the change rate of the DB</p></td>
</tr>
</tbody>
</table>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id4" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">1</a><span class="fn-bracket">]</span></span>
<p>Additional improvements could be made to reduce this as long as
Ghostferry is faster than the rate of change. See
<a class="reference external" href="https://github.com/Shopify/ghostferry/issues/13">https://github.com/Shopify/ghostferry/issues/13</a>.</p>
</aside>
<aside class="footnote brackets" id="id5" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">2</a><span class="fn-bracket">]</span></span>
<p>Increase in copy time does not increase downtime. Downtime occurs only
in cutover.</p>
</aside>
</aside>
<p>If you want verification, you should try with the <code class="docutils literal notranslate"><span class="pre">ChecksumTableVerifier</span></code>
first if you’re copying whole tables at a time. If that takes too long, you can
try using the <code class="docutils literal notranslate"><span class="pre">InlineVerifier</span></code>.  Alternatively, you can verify in a staging
run and not verify during the production run (see <a class="reference internal" href="copydbinprod.html#copydbinprod"><span class="std std-ref">Running ghostferry-copydb in production</span></a>).</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">InlineVerifier</span></code> on its own may potentially miss some
cases, and using it with the <code class="docutils literal notranslate"><span class="pre">TargetVerifier</span></code> is recommended if these
cases are possible.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Conditions</p></td>
<td><p>ChecksumTable</p></td>
<td><p>Inline</p></td>
<td><p>Inline + Target</p></td>
</tr>
<tr class="row-even"><td><p>Data inconsistency due to Ghostferry issuing an
incorrect UPDATE on the target database (example:
encoding-type issues).</p></td>
<td><p>Yes <a class="footnote-reference brackets" href="#id12" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a></p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>Data inconsistency due to Ghostferry failing to
INSERT on the target database.</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p>Data inconsistency due to Ghostferry failing to
DELETE on the target database.</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>Data inconsistency due to rogue application
issuing writes (INSERT/UPDATE/DELETE) against the
target database.</p></td>
<td><p>Yes</p></td>
<td><p>Sometimes <a class="footnote-reference brackets" href="#id13" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a></p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-even"><td><p>Data inconsistency due to missing binlog events
when Ghostferry is resumed from the wrong
binlog coordinates.</p></td>
<td><p>Yes</p></td>
<td><p>Sometimes <a class="footnote-reference brackets" href="#id14" id="id8" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a></p></td>
<td><p>Sometimes <a class="footnote-reference brackets" href="#id14" id="id9" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a></p></td>
</tr>
<tr class="row-odd"><td><p>Data inconsistency if Ghostferry’s Binlog writing
implementation is incorrect and modified the
wrong row on the target (example, an UPDATE is
supposed to go to id = 1 but Ghostferry instead
issued a query for id = 2). This is an unrealistic
scenario, but is included for illustrative
purposes.</p></td>
<td><p>Yes</p></td>
<td><p>Probably not
<a class="footnote-reference brackets" href="#id15" id="id10" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a></p></td>
<td><p>Probably not
<a class="footnote-reference brackets" href="#id15" id="id11" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a></p></td>
</tr>
</tbody>
</table>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id12" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">3</a><span class="fn-bracket">]</span></span>
<p>Note that the CHECKSUM TABLE statement is broken in MySQL 5.7 for tables
with JSON columns. These tables will result in a false positive event:
even if two tables are identical, they can emit different checksums. See
<a class="reference external" href="https://bugs.mysql.com/bug.php?id=87847">https://bugs.mysql.com/bug.php?id=87847</a>. This applies to every row in
this table.</p>
</aside>
<aside class="footnote brackets" id="id13" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">4</a><span class="fn-bracket">]</span></span>
<p>If the rows modified by the rogue application are modified again on
the source after Ghostferry starts, the InlineVerifier’s binlog tailer
should pick up that row and attempt to reverify it.</p>
</aside>
<aside class="footnote brackets" id="id14" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id8">1</a>,<a role="doc-backlink" href="#id9">2</a>)</span>
<p>If the rows missed after resume are modified again on the source after
Ghostferry starts, the InlineVerifier’s binlog tailer should pick up
that row and attempt to reverify it.</p>
</aside>
<aside class="footnote brackets" id="id15" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id10">1</a>,<a role="doc-backlink" href="#id11">2</a>)</span>
<p>If the implementation of the Ghostferry algorithm is so broken, chances
are the InlineVerifier won’t catch it either as it relies on the same
algorithm to enumerate the table and tail the binlogs.</p>
</aside>
</aside>
<section id="iterativeverifier-deprecated">
<h2>IterativeVerifier (Deprecated)<a class="headerlink" href="#iterativeverifier-deprecated" title="Link to this heading">¶</a></h2>
<p><strong>NOTE! This is a deprecated verifier. Use the InlineVerifier instead.</strong></p>
<p>IterativeVerifier verifies the source and target in a couple of steps:</p>
<ol class="arabic simple">
<li><p>After the data copy, it first compares the hashes of each applicable rows
of the source and the target together to make sure they are the same. This
is known as the initial verification.</p>
<ol class="loweralpha simple">
<li><p>If they are the same: the verification for that row is complete.</p></li>
<li><p>If they are not the same: add it into a reverify queue.</p></li>
</ol>
</li>
<li><p>For any rows changed during the initial verification process, add it into
the reverify queue.</p></li>
<li><p>After the initial verification, verify the rows’ hashes in the
reverification queue again. This is done to reduce the time needed to
reverify during the cutover as we assume the reverification queue will
become smaller during this process.</p></li>
<li><p>During the cutover stage, verify all rows’ hashes in the reverify queue.</p>
<ol class="loweralpha simple">
<li><p>If they are the same: the verification for that row is complete.</p></li>
<li><p>If they are not the same: the verification fails.</p></li>
</ol>
</li>
<li><p>If no verification failure occurs, the source and the target are identical.
If verification failure does occur (4b), then the source and target are not
identical.</p></li>
</ol>
<p>A proof of concept TLA+ verification of this algorithm is done in
<a class="reference external" href="https://github.com/Shopify/ghostferry/tree/iterative-verifier-tla">https://github.com/Shopify/ghostferry/tree/iterative-verifier-tla</a>.</p>
</section>
<section id="inlineverifier">
<h2>InlineVerifier<a class="headerlink" href="#inlineverifier" title="Link to this heading">¶</a></h2>
<p>InlineVerifier verifies the source and target inline with the other components with
a few slight differences from the IterativeVerifier above. The primary difference
being that this verification process happens while the data is being copied by the
DataIterator instead of after the fact.</p>
<p>With regards to the <code class="docutils literal notranslate"><span class="pre">DataIterator</span></code> and <code class="docutils literal notranslate"><span class="pre">BatchWriter</span></code>:</p>
<ol class="arabic">
<li><p>While selecting the data in the <code class="docutils literal notranslate"><span class="pre">DataIterator</span></code>, a fingerprint is appended
to the end of the statement that <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> s data from the source as
<code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">*,</span> <span class="pre">MD5(...)</span> <span class="pre">FROM</span> <span class="pre">...</span></code></p></li>
<li><p>The fingerprint, gathered from the <code class="docutils literal notranslate"><span class="pre">MD5(...)</span></code> of the query above is stored
on the <code class="docutils literal notranslate"><span class="pre">RowBatch</span></code> to be used in the next verification step.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">BatchWriter</span></code> then attempts to write the <code class="docutils literal notranslate"><span class="pre">RowBatch</span></code>, but instead of inserting
it directly, the following process is taken:</p>
<ol class="loweralpha simple">
<li><p>A transaction is opened.</p></li>
<li><p>The data contained in the <code class="docutils literal notranslate"><span class="pre">RowBatch</span></code> is inserted.</p></li>
<li><p>The PK and fingerprint is then <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> ed from the Target
as <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">pk,</span> <span class="pre">MD5(....)</span> <span class="pre">FROM</span> <span class="pre">...</span></code>.</p></li>
<li><p>The fingerprint (<code class="docutils literal notranslate"><span class="pre">MD5</span></code>) is then checked against the fingerprint currently
stored on the <code class="docutils literal notranslate"><span class="pre">RowBatch</span></code>.</p></li>
</ol>
<p>The process in step 3 above is retried (with a limit) if there happens to be
a failure or mismatch, and will fail the run if they are not verified within
the retry limits.</p>
</li>
</ol>
<p>With regards to the BinlogStreamer:</p>
<ol class="arabic simple">
<li><p>As DMLs are observed by the <code class="docutils literal notranslate"><span class="pre">BinlogStreamer</span></code>, the PKs of the events are placed into
a <code class="docutils literal notranslate"><span class="pre">reverifyStore</span></code> to be periodically verified for correctness.</p></li>
<li><p>This continues to happen in the background throughout the process of the Run.</p></li>
<li><p>If a PK is found not to match, it is added back into the reverifyStore to be verified
again.</p></li>
<li><p>When <code class="docutils literal notranslate"><span class="pre">VerifyBeforeCutover</span></code> starts, the InlineVerifier will verify enough of the
events in the <code class="docutils literal notranslate"><span class="pre">reverifyStore</span></code> to ensure it has a sufficiently small number of events
that can be successfully verified before cutover.</p></li>
<li><p>When <code class="docutils literal notranslate"><span class="pre">VerifyDuringCutover</span></code> begins, all of the remaining events in the <code class="docutils literal notranslate"><span class="pre">reverifyStore</span></code>
are verified and any mismatches are returned.</p></li>
</ol>
</section>
<section id="targetverifier">
<h2>TargetVerifier<a class="headerlink" href="#targetverifier" title="Link to this heading">¶</a></h2>
<p>TargetVerifier ensures data on the Target is not corrupted during the move process
and is meant to be used in conjunction with another verifier above.</p>
<p>It uses a configurable annotation string that is prepended to DMLs that acts as
a verified “signature” of all of Ghostferry’s operations on the Target:</p>
<ol class="arabic simple">
<li><p>A BinlogStreamer is created and attached to the Target</p></li>
<li><p>As this BinlogStreamer receives DML events, it attempts to extract the annotation
from each for each of the <code class="docutils literal notranslate"><span class="pre">RowsEvents</span></code>.</p></li>
</ol>
<p>3. If an annotation is not found for the DML, or the extracted annotation does not
match the configured annotation of Ghostferry, an error is returned and the process fails.</p>
<p>The TargetVerifier needs to be manually stopped before cutover. If it is not stopped,
it may detect writes from the application (that are not from Ghostferry) and fail the run.
Stopping before cutover also gives the TargetVerifier the opportunity to inspect all
of the DMLs in its <code class="docutils literal notranslate"><span class="pre">BinlogStreamer</span></code> queue to ensure no corruption of the data has occurred.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Ghostferry</a></h1>



<p class="blurb"> The swiss army knife of live data migrations</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Shopify&repo=ghostferry&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction to Ghostferry</a></li>
<li class="toctree-l1"><a class="reference internal" href="technicaloverview.html">Technical Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorialcopydb.html">Tutorial for ghostferry-copydb</a></li>
<li class="toctree-l1"><a class="reference internal" href="copydbinprod.html">Running <code class="docutils literal notranslate"><span class="pre">ghostferry-copydb</span></code> in production</a></li>
<li class="toctree-l1"><a class="reference internal" href="copydbinterruptresume.html">Interrupt and resuming <code class="docutils literal notranslate"><span class="pre">ghostferry-copydb</span></code></a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Verifiers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#iterativeverifier-deprecated">IterativeVerifier (Deprecated)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inlineverifier">InlineVerifier</a></li>
<li class="toctree-l2"><a class="reference internal" href="#targetverifier">TargetVerifier</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="howtousecustom.html">Using Ghostferry in Custom Applications</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="copydbinterruptresume.html" title="previous chapter">Interrupt and resuming <code class="docutils literal notranslate"><span class="pre">ghostferry-copydb</span></code></a></li>
      <li>Next: <a href="howtousecustom.html" title="next chapter">Using Ghostferry in Custom Applications</a></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2017-2024, Shopify.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
      |
      <a href="_sources/verifiers.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>